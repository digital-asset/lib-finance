
-- Copyright (c) 2019, Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved.
-- SPDX-License-Identifier: Apache-2.0

daml 1.2
module Test.Trigger.Finance.Market where

import DA.Date
import DA.Next.Set as Set

import DA.Finance.Instrument.Equity

import Test.Finance.Market.Asset
import Test.Finance.Market.Dvp
import Test.Finance.Market.Party
import Test.Finance.Market.Startup
import Test.Finance.Utils

market = scenario do
  (Parties{..}, AssetMarket{..}, DvpMarket{..}) <- startup

  -- -- Instruct Dvp
  -- submit charlie do
  --   exerciseByKey @DvpInstructionRule (maIdMap ! "Charlie&Alice") DvpInstruction_Process with
  --     dvpCid = dvpMap ! "Charlie&Alice:Dvp:0"
  --     paymentSteps =
  --       [[ initSettlementDetails accountMap gencoBank charlie gencoBank
  --        , initSettlementDetails accountMap cb gencoBank acmeBank
  --        , initSettlementDetails accountMap acmeBank acmeBank alice
  --       ]]
  --     deliverySteps =
  --       [[ initSettlementDetails accountMap acmeBank alice acmeBank
  --        , initSettlementDetails accountMap csd acmeBank gencoBank
  --        , initSettlementDetails accountMap gencoBank gencoBank charlie
  --       ]]
  --     ctrl = charlie

  -- submit alice do
  --   exerciseByKey @DvpInstructionRule (maIdMap ! "Charlie&Alice") DvpInstruction_Process with
  --     dvpCid = dvpMap ! "Charlie&Alice:Dvp:1"
  --     paymentSteps =
  --       [[ initSettlementDetails accountMap gencoBank charlie gencoBank
  --        , initSettlementDetails accountMap cb gencoBank acmeBank
  --        , initSettlementDetails accountMap acmeBank acmeBank alice
  --       ]]
  --     deliverySteps =
  --       [[ initSettlementDetails accountMap acmeBank alice acmeBank
  --        , initSettlementDetails accountMap csd acmeBank gencoBank
  --        , initSettlementDetails accountMap gencoBank gencoBank charlie
  --       ]]
  --     ctrl = alice
    
  -- Corporate action
  submit reuters do
    create EquityCashDividend with
      id = initAssetId reuters "DAH" 0
      exDate = date 1970 Jan 1
      settlementDate = date 1970 Jan 1
      perShare = initAsset reuters "USD" 0 0.4
      observers = Set.fromList $ mapValues $ fmap (.owner) accountMap
